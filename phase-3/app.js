/* Algebra Tutor â€“ full app.js with Chart.js safe reuse */ 
console.log('[Algebra] full app.js (graph fix) loaded');
const $=s=>document.querySelector(s);const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));function randInt(a,b){return(Math.random()*(b-a+1)|0)+a}function gcd(a,b){a=Math.abs(a);b=Math.abs(b);while(b){[a,b]=[b,a%b]}return a||1}function simplifyFraction(n,d){const g=gcd(n,d);const s=(d<0?-1:1);return[s*n/g,Math.abs(d)/g]}function F(n,d){const[nn,dd]=simplifyFraction(n,d);return dd===1?String(nn):`${nn}/${dd}`}function fracToNumber(s){if(typeof s==='number')return s;if(typeof s!=='string')return NaN;s=s.trim();if(s.includes('/')){const[n,d]=s.split('/').map(Number);return n/d}return Number(s)}function approxEqual(a,b,t=1e-3){return Math.abs(fracToNumber(a)-fracToNumber(b))<=t}function shuffle(a){return a.map(v=>[Math.random(),v]).sort((x,y)=>x[0]-y[0]).map(x=>x[1])}
const RKEY='algebra_roster';const LS_KEY=s=>`algebra_progress_${s||'Learner'}`;function getRoster(){try{return JSON.parse(localStorage.getItem(RKEY))||['Learner']}catch{return['Learner']}}function setRoster(l){localStorage.setItem(RKEY,JSON.stringify([...new Set(l)]))}function getProgress(s){try{return JSON.parse(localStorage.getItem(LS_KEY(s)))||{user:s,modules:{}}}catch{return{user:s,modules:{}}}}function saveProgress(p){localStorage.setItem(LS_KEY(p.user),JSON.stringify(p))}function lessonBest(p,m,l){try{return p.modules[m].lessons[l].best||0}catch{return 0}}function recordScore(p,m,l,c,t){const sc=t?c/t:0;p.modules[m]=p.modules[m]||{lessons:{}};const L=p.modules[m].lessons[l]=p.modules[m].lessons[l]||{best:0,history:[]};L.history.push({correct:c,total:t,ts:Date.now()});L.best=Math.max(L.best,sc);saveProgress(p)}
const gen_linear_eq=()=>{const a=[2,3,4,5,6,7,8,9][randInt(0,7)],x=randInt(-6,6),b=randInt(-9,9),c=a*x+b;const ans=F(c-b,a);return{prompt:`Solve for x: ${a}x + ${b} = ${c}`,type:'numeric',answer:ans,hint:'Undo addition/subtraction, then division.',solution:`${a}x=${c-b}; x=(${c-b})/${a}=${ans}`}};const gen_slope=()=>{let x1=randInt(-6,6),y1=randInt(-6,6),x2=x1,y2=y1;while(x2===x1)x2=randInt(-6,6);y2=randInt(-6,6);const ans=F(y2-y1,x2-x1);return{prompt:`Find the slope through (${x1}, ${y1}) and (${x2}, ${y2}).`,type:'numeric',answer:ans,hint:'m=(y2âˆ’y1)/(x2âˆ’x1)',solution:`m=(${y2}-${y1})/(${x2}-${x1})=${ans}`}};const gen_percent=()=>{const base=[40,50,60,80,100,120][randInt(0,5)],pct=[5,10,12,15,20,25][randInt(0,5)],nv=base*(1+pct/100);return{prompt:`A price is $${base} and increases by ${pct}%. What is the new price?`,type:'numeric',answer:String(nv),hint:'Multiply by (1+percent).',solution:`New=${base}*(1+${pct}/100)=${nv}`}};const gen_exponent_rules=()=>{let a=randInt(1,5),b=randInt(1,5);if(Math.random()<0.5){const ans=`x^${a+b}`;const opts=[ans,`x^${a*b}`,`x^${a-b-1}`,`x^${a+b+1}`];return{prompt:`Simplify: x^${a} * x^${b}`,type:'mcq',answer:ans,options:shuffle(opts),hint:'Add exponents.',solution:'Same base multiply â†’ add exponents.'}}else{if(a<b)[a,b]=[b,a];const ans=`x^${a-b}`;const opts=[ans,`x^${a*b}`,`x^${a-b-1}`,`x^${a+b+1}`];return{prompt:`Simplify: x^${a} / x^${b}`,type:'mcq',answer:ans,options:shuffle(opts),hint:'Subtract exponents.',solution:'Same base divide â†’ subtract exponents.'}}};const gen_quadratic_roots=()=>{const S=[-5,-4,-3,-2,-1,1,2,3,4,5],p=S[randInt(0,S.length-1)],q=S[randInt(0,S.length-1)];const b=p+q,c=p*q;const r1=-p,r2=-q,small=Math.min(r1,r2);return{prompt:`Solve x^2 + ${b}x + ${c} = 0 (give the smaller root)`,type:'numeric',answer:String(small),hint:'Find two numbers that multiply to c and add to b.',solution:`(x+${p})(x+${q})=0 â†’ x=${-p} or ${-q}`}};const gen_proportion=()=>{const a=randInt(2,9),b=randInt(2,9),c=randInt(2,9),num=b*c,den=a,ans=F(num,den);return{prompt:`Solve for x: ${a}/${b} = ${c}/x`,type:'numeric',answer:ans,hint:'Cross-multiply.',solution:`${a}x=${b}Â·${c} â†’ x=${num}/${den}=${ans}`}};
const LESSONS={'0':{title:'Preâ€‘Algebra Essentials',description:'PEMDAS, integers, fractions',items:[{id:'0.1',title:'Order of Operations (PEMDAS)',objectives:['Evaluate in PEMDAS order','Avoid MD/AS leftâ€‘toâ€‘right mistakes'],notes:'PEMDAS: Parentheses, Exponents, then MD leftâ€‘toâ€‘right, then AS leftâ€‘toâ€‘right.',examples:['7+3*4=19','(7+3)*4=40'],bank:[{prompt:'Compute: 8 + 2 * 5',type:'numeric',answer:'18',hint:'Multiply before adding.',solution:'2*5=10, 8+10=18'},{prompt:'Compute: (8 + 2) * 5',type:'numeric',answer:'50',hint:'Parentheses first.',solution:'10*5=50'},{prompt:'Which equals 3 + 2^3?',type:'mcq',answer:'11',options:['11','25','16','13'],hint:'Exponents before addition.',solution:'2^3=8 â†’ 11'}]},{id:'0.2',title:'Integers & Number Line',objectives:['Add/subtract integers','Absolute value'],notes:'Integers include negatives. |x| is distance from 0.',examples:['-3+5=2','|-7|=7'],bank:[{prompt:'Compute: -4 + 9',type:'numeric',answer:'5'},{prompt:'What is | -12 | ?',type:'numeric',answer:'12'}]},{id:'0.3',title:'Fractions & Decimals',objectives:['Convert fracâ†”dec','Add like denominators'],notes:'Divide numerator by denominator to get decimal; add numerators for like denominators.',examples:['3/4=0.75','1/5+2/5=3/5'],bank:[{prompt:'Convert 1/8 to decimal',type:'numeric',answer:'0.125',hint:'1 Ã· 8'},{prompt:'Compute: 2/7 + 3/7',type:'numeric',answer:'5/7'}]}]},'1':{title:'Variables & Expressions',description:'Variables and evaluation',items:[{id:'1.1',title:'Variables & Expressions',objectives:['Variables','Evaluate by substitution','Translate wordsâ†’algebra'],notes:'A variable stands for a number.',examples:['x=4 â‡’ 3x+2=14','Twice a number plus 5 â†’ 2x+5'],bank:[{prompt:'If x=5, what is 2x+7?',type:'numeric',answer:'17'},{prompt:"Which expression means 'three more than twice n'?",type:'mcq',answer:'2n+3',options:['2n+3','3n+2','n/2+3','3-2n']}]}]},'2':{title:'Equations & Inequalities',description:'1â€‘step/2â€‘step equations, inequalities',items:[{id:'2.1',title:'Solving 1â€‘Step & 2â€‘Step Equations',objectives:['Solve ax+b=c','Check by substitution'],notes:'Undo addition/subtraction, then multiplication/division.',examples:['2x+5=11 â‡’ x=3','x/4âˆ’2=3 â‡’ x=20'],bank:[gen_linear_eq(),gen_linear_eq(),{prompt:'Solve for x: x/3 + 4 = 9',type:'numeric',answer:'15'}]},{id:'2.2',title:'Inequalities',objectives:['Solve linear inequalities','Flip sign when Ã—/Ã· by negative'],notes:'Like equations, but flip sign when Ã— or Ã· by a negative.',examples:['3xâˆ’2>7 â‡’ x>3','âˆ’2xâ‰¤8 â‡’ xâ‰¥âˆ’4'],bank:[{prompt:'Solve: 3x âˆ’ 5 > 1',type:'short',answer:'x>2'},{prompt:'Solve: âˆ’4x â‰¤ 12',type:'short',answer:'xâ‰¥-3'}]}]},'3':{title:'Graphing Lines',description:'Slope, intercepts',items:[{id:'3.1',title:'Slopeâ€‘Intercept Form',objectives:['Slope from 2 points','Identify m and b'],notes:'In y=mx+b, m is slope; b is yâ€‘intercept.',examples:['y=2x+3 â†’ m=2, b=3'],bank:[gen_slope(),{prompt:'In y=âˆ’3x+7, what is the slope?',type:'numeric',answer:'-3'},{prompt:'In y=0.5xâˆ’4, what is the yâ€‘intercept?',type:'numeric',answer:'-4'}]}]},'4':{title:'Systems of Equations',description:'Substitution & elimination',items:[{id:'4.1',title:'Systems',objectives:['Solve by substitution/elimination','Solutions count'],notes:'Substitute or eliminate to solve.',examples:['x+y=10, xâˆ’y=2 â‡’ x=6, y=4'],bank:[{prompt:'Solve: x + y = 9 and x âˆ’ y = 3. What is x?',type:'numeric',answer:'6'},{prompt:'Solve: x = 2y and 3x âˆ’ y = 11. What is y?',type:'numeric',answer:'11/5'}]}]},'5':{title:'Exponents & Polynomials',description:'Exponent rules & combining terms',items:[{id:'5.1',title:'Exponents & Polynomials',objectives:['Apply exponent rules','Combine like terms'],notes:'x^a*x^b=x^(a+b); x^a/x^b=x^(aâˆ’b). Combine like terms only.',examples:['3x^2+5x^2=8x^2'],bank:[gen_exponent_rules(),{prompt:'Combine like terms: 4x^2 + 3x âˆ’ 2x^2 + x',type:'mcq',answer:'2x^2 + 4x',options:['2x^2 + 4x','6x^2 + 4x','2x^2 + 3x','x^2 + 4x']}]},'6':{title:'Factoring & Quadratics',description:'Factor & solve',items:[{id:'6.1',title:'Quadratics (Factoring)',objectives:['Factor simple quadratics','Solve by factoring'],notes:'x^2+bx+c â†’ numbers that multiply to c and add to b.',examples:['x^2+5x+6=(x+2)(x+3)'],bank:[gen_quadratic_roots(),{prompt:'Solve x^2 âˆ’ 9 = 0 (give the positive root)',type:'numeric',answer:'3'}]}]},'7':{title:'Word Problems & Modeling',description:'Proportions, percent, unit rate',items:[{id:'7.1',title:'Word Problems & Proportional Reasoning',objectives:['Translate wordsâ†’equations','Proportions & percents'],notes:'Identify the unknown, write the equation, solve.',examples:['180 miles in 3 hours â†’ 60 mph'],bank:[gen_proportion(),gen_percent()]}]};
const PRACTICE={'linear':['Linear equations',gen_linear_eq],'slope':['Slope from two points',gen_slope],'percent':['Percent change',gen_percent],'exponent':['Exponent rules',gen_exponent_rules],'quadratic':['Quadratic factoring',gen_quadratic_roots],'proportion':['Proportion solving',gen_proportion]};
let currentStudent=null,progress=null,__chart=null;
function fillSelect(s,it){const e=$(s);e.innerHTML='';for(const o of it.map(v=>typeof v==='string'?{value:v,label:v}:v)){const n=document.createElement('option');n.value=o.value;n.textContent=o.label;e.appendChild(n)}}
function onModuleChange(){const mid=$('#moduleSelect').value;const items=LESSONS[mid].items.map((L,i)=>({value:i,label:`${L.id} â€“ ${L.title}`}));fillSelect('#lessonSelect',items);const L=LESSONS[mid].items[0];$('#lessonIntro').innerHTML=`<div class="muted"><b>Objectives:</b> ${L.objectives.join('; ')}<br><b>Notes:</b> ${L.notes}</div>`}
function switchStudent(n){currentStudent=n;progress=getProgress(currentStudent);updateStorageInfo();drawChart()}
function updateStorageInfo(){const bytes=(localStorage.getItem(LS_KEY(currentStudent))||'').length;$('#storageInfo').textContent=`Local save: ${(bytes/1024).toFixed(1)} KB`}
function setTitle(t){$('#activityTitle').textContent=t}
const PASS=0.70;
function startPlacement(){setTitle('Placement Quiz');const bank=shuffle([{prompt:'Compute: 6 + 3 * 4',type:'numeric',answer:'18',hint:'Multiply before adding.'},{prompt:'What is | -9 | ?',type:'numeric',answer:'9'},{prompt:'If x=3, what is 4xâˆ’2?',type:'numeric',answer:'10'},{prompt:'Solve: 2x+5=15',type:'numeric',answer:'5'},gen_slope(),gen_exponent_rules(),gen_quadratic_roots(),gen_proportion()]);runQuestionSet(bank,(c,t)=>{$('#placementResult').innerHTML=`<b>Score:</b> ${c}/${t} = ${t?Math.round(100*c/t):0}%`})}
function startLesson(){const mid=$('#moduleSelect').value;const idx=Number($('#lessonSelect').value);const L=LESSONS[mid].items[idx];setTitle(`Lesson: ${L.title}`);const qs=L.bank.slice();runQuestionSet(qs,(c,t)=>{recordScore(progress,String(mid),L.id,c,t);const pct=t?Math.round(100*c/t):0;const passed=(c/t)>=PASS;$('#activity').innerHTML=`<div class="card">Lesson score: <b>${c}/${t} = ${pct}%</b><br>${passed?'ðŸŽ‰ Mastery achieved!':'ðŸ“ˆ Keep practicing to improve.'}</div>`;drawChart()})}
function startPractice(){const key=$('#practiceSelect').value;const n=clamp(Number($('#practiceCount').value)||5,1,50);const gen=PRACTICE[key][1];const qs=Array.from({length:n},()=>gen());setTitle(`Practice: ${PRACTICE[key][0]} (${n})`);runQuestionSet(qs,()=>{$('#activity').innerHTML+=`<div class="muted mt8">Practice finished.</div>`})}
function runQuestionSet(qs,onFinish){let i=0,c=0,t=qs.length;const host=$('#activity');host.innerHTML='';const render=()=>{if(i>=qs.length){onFinish(c,t);return}const q=qs[i];host.innerHTML=`<div class="card"><div class="muted">Question ${i+1}/${qs.length}</div><div class="mt8">${q.prompt}</div><div class="mt8" id="answerArea"></div><div class="row mt8"><button id="submitBtn" class="primary">Submit</button><button id="hintBtn">Hint</button><button id="explainBtn">Explain</button><button id="skipBtn">Skip</button></div><div id="feedback" class="mt8 muted"></div></div>`;const area=$('#answerArea');let getVal=()=>'';if(q.type==='mcq'){const L='ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');area.innerHTML=q.options.map((opt,idx)=>`<label class="row"><input type="radio" name="opt" value="${opt}"> ${L[idx]}. ${opt}</label>`).join('');getVal=()=>{const sel=document.querySelector('input[name=opt]:checked');return sel?sel.value:''}}else{area.innerHTML=`<input id="ansInput" type="text" placeholder="Your answer"/>`;getVal=()=>$('#ansInput').value.trim()}$('#hintBtn').onclick=()=>$('#feedback').textContent=q.hint||'Try smaller steps.';$('#explainBtn').onclick=()=>$('#feedback').textContent=q.solution||'We will walk through steps after you try.';$('#skipBtn').onclick=()=>{i++;render()};$('#submitBtn').onclick=()=>{const v=getVal();if(!v){$('#feedback').textContent='Enter or choose an answer.';return}let ok=false;if(q.type==='mcq'){ok=String(v).toLowerCase()===String(q.answer).toLowerCase()}else if(q.type==='numeric'){ok=approxEqual(v,q.answer)}else{ok=String(v).toLowerCase()===String(q.answer).toLowerCase()}$('#feedback').textContent=ok?'âœ… Correct!':`âŒ Not quite. One answer: ${q.answer}`;if(ok)c++;setTimeout(()=>{i++;render()},500)}};render()}
function drawChart(){const canvas=document.getElementById('progressChart');if(!canvas||!window.Chart)return;const labels=[],values=[];for(const[mid,mod]of Object.entries(LESSONS)){for(const L of mod.items){labels.push(`${mid}:${L.id}`);values.push(lessonBest(progress,mid,L.id)*100)}}if(Chart.getChart){const ex=Chart.getChart(canvas);if(ex)ex.destroy()}if(__chart&&typeof __chart.destroy==='function'){try{__chart.destroy()}catch(e){}__chart=null}__chart=new Chart(canvas,{type:'bar',data:{labels,datasets:[{label:'Best Score %',data:values}]},options:{scales:{y:{min:0,max:100}},plugins:{legend:{display:false}},responsive:true,maintainAspectRatio:false}})}
function initUI(){const roster=getRoster();currentStudent=roster[0];progress=getProgress(currentStudent);fillSelect('#studentSelect',roster.map(n=>({value:n,label:n})));$('#studentSelect').value=currentStudent;updateStorageInfo();$('#addStudentBtn').onclick=()=>{const nm=prompt('Student name:');if(!nm)return;const list=getRoster();list.push(nm);setRoster(list);fillSelect('#studentSelect',getRoster().map(n=>({value:n,label:n})));$('#studentSelect').value=nm;switchStudent(nm)};$('#delStudentBtn').onclick=()=>{const list=getRoster().filter(n=>n!==currentStudent);if(!confirm(`Delete ${currentStudent}?`))return;setRoster(list.length?list:['Learner']);const newName=getRoster()[0];fillSelect('#studentSelect',getRoster().map(n=>({value:n,label:n})));switchStudent(newName)};$('#studentSelect').onchange=e=>switchStudent(e.target.value);const moduleOpts=Object.entries(LESSONS).map(([k,m])=>({value:k,label:`[${k}] ${m.title}`}));fillSelect('#moduleSelect',moduleOpts);$('#moduleSelect').onchange=onModuleChange;onModuleChange();const pOpts=Object.entries(PRACTICE).map(([k,[name]])=>({value:k,label:name}));fillSelect('#practiceSelect',pOpts);fillSelect('#worksheetTopic',pOpts);$('#startPlacement').onclick=startPlacement;$('#startLesson').onclick=startLesson;$('#startPractice').onclick=startPractice;$('#downloadTxt').onclick=()=>downloadWorksheet(false);$('#downloadPdf').onclick=()=>downloadWorksheet(true);$('#refreshChart').onclick=drawChart;drawChart()}window.addEventListener('DOMContentLoaded',initUI);
function downloadText(f,t){const b=new Blob([t],{type:'text/plain'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=f;a.click();URL.revokeObjectURL(u)}function downloadWorksheet(asPdf=false){const key=document.querySelector('#worksheetTopic').value;const n=clamp(Number(document.querySelector('#worksheetCount').value)||10,1,50);const[name,gen]=PRACTICE[key];const P=[],A=[];for(let i=0;i<n;i++){const q=gen();const p=q.prompt.replace(' (give the smaller root)','');P.push(`${i+1}. ${p}`);A.push(`${i+1}. ${q.answer}`)}if(!asPdf){downloadText(`worksheet_${key}_${n}.txt`,`Algebra Worksheet - ${name}\n\n${P.join('\n')}`);downloadText(`worksheet_${key}_${n}_answers.txt`,`Answer Key - ${name}\n\n${A.join('\n')}`);return}if(!window.jspdf){alert('jsPDF not available yet. Open once online to cache.');return}const{jsPDF}=window.jspdf;const mk=(fn,ans=false)=>{const d=new jsPDF({unit:'pt',format:'letter'});const m=54;let y=m;const w=612;const lh=16;d.setFont('Helvetica','bold');d.setFontSize(16);d.text(ans?`Answer Key â€“ ${name}`:`Worksheet â€“ ${name}`,m,y);y+=24;d.setFont('Helvetica','normal');d.setFontSize(12);const arr=ans?P.map((p,i)=>`${p}    Ans: ${A[i].split('. ')[1]}`):P;for(const line of arr){const wrap=d.splitTextToSize(line,w-2*m);for(const s of wrap){if(y>756){d.addPage();y=m}d.text(s,m,y);y+=lh}y+=6}d.save(fn)};mk(`worksheet_${key}_${n}.pdf`,false);mk(`worksheet_${key}_${n}_answers.pdf`,true)}